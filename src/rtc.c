#include "debug.h"
#include "rtc.h"

//                  en ac ad       s    as     m    am     h    ah    dw     d     M     y    ra    rb    rc    rd
rtc_t mrgluk_rtc = { 1, 0, 0, 
                              { 0x17, 0xFF, 0x49, 0xFF, 0x20, 0xFF, 0x00, 0x02, 0x03, 0x25, 0x20, 0x03, 0x00, 0x80, 0x80, 0xFF, 
                                0x00, 0xAA, 0x47, 'R', 'T', 'C', ' ', 'e', 'm', 'u', 'l', 'a', 't', 'o', 'r', 
                                ' ', 'b', 'y', ' ', 'M', 'a', 'k', 's', 'y', 'm', '/', '7', 'F', 'F', 'D', 0xFF, 0xFF, 
                                0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
                                0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
                                0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
                                0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
                                0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
                              } 
};

static u_int8_t rtc_dec2bcd(u_int8_t num)
{
    return (((u_int8_t)(num/10)%10))<<4 | (num%10);
}

void rtc_update(rtc_t* prtc)
{
    if(prtc->addr < 10)
    {
        time_t rawtime = time(NULL);
        struct tm *info = localtime(&rawtime);
        prtc->mem.second = rtc_dec2bcd(info->tm_sec);
        prtc->mem.minute = rtc_dec2bcd(info->tm_min);
        prtc->mem.hour = rtc_dec2bcd(info->tm_hour);
        prtc->mem.dayOfWeek = rtc_dec2bcd(info->tm_wday);
        prtc->mem.day = rtc_dec2bcd(info->tm_mday);
        prtc->mem.month = rtc_dec2bcd(info->tm_mon+1);
        prtc->mem.year = rtc_dec2bcd(info->tm_year);
    }
}